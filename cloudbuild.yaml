steps:
  # Install backend dependencies
  - name: 'node:18'
    dir: 'backend'
    entrypoint: 'npm'
    args: ['install']
    id: 'backend-install'
    
  # Build backend docker image
  - name: 'gcr.io/cloud-builders/docker'
    dir: 'backend'
    args: ['build', '-t', 'gcr.io/empyrean-harbor-456906-s2/backend:latest', '.']
    id: 'backend-build'
    waitFor: ['backend-install']

  # Push backend to Container Registry
  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', 'gcr.io/empyrean-harbor-456906-s2/backend:latest']
    id: 'backend-push'
    waitFor: ['backend-build']

  # Install frontend dependencies
  - name: 'node:18'
    dir: 'frontend'
    entrypoint: 'npm'
    args: ['install']
    id: 'frontend-install'
    
  # Fix permissions for vite
  - name: 'node:18'
    dir: 'frontend'
    entrypoint: 'chmod'
    args: ['-R', '755', './node_modules/.bin/']
    id: 'fix-permissions'
    waitFor: ['frontend-install']
    
  # Build frontend docker image with production build
  - name: 'gcr.io/cloud-builders/docker'
    dir: 'frontend'
    args: ['build', '-t', 'gcr.io/empyrean-harbor-456906-s2/frontend:latest', '.']
    id: 'frontend-docker-build'
    waitFor: ['fix-permissions']

  # Push frontend to Container Registry
  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', 'gcr.io/empyrean-harbor-456906-s2/frontend:latest']
    id: 'frontend-push'
    waitFor: ['frontend-docker-build']
    
  # Add version tag to image for Argo CD detection
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk' 
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        docker tag gcr.io/empyrean-harbor-456906-s2/backend:latest gcr.io/empyrean-harbor-456906-s2/backend:$BUILD_ID
        docker tag gcr.io/empyrean-harbor-456906-s2/frontend:latest gcr.io/empyrean-harbor-456906-s2/frontend:$BUILD_ID
        docker push gcr.io/empyrean-harbor-456906-s2/backend:$BUILD_ID
        docker push gcr.io/empyrean-harbor-456906-s2/frontend:$BUILD_ID
    id: 'tag-images'
    waitFor: ['backend-push', 'frontend-push']

  # Update image tag in deployment yaml
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        sed -i "s|gcr.io/empyrean-harbor-456906-s2/backend:.*|gcr.io/empyrean-harbor-456906-s2/backend:${BUILD_ID}|g" backend-deployment.yaml
        sed -i "s|gcr.io/empyrean-harbor-456906-s2/frontend:.*|gcr.io/empyrean-harbor-456906-s2/frontend:${BUILD_ID}|g" frontend-deployment.yaml
    id: 'update-yaml'
    waitFor: ['tag-images']

  # Commit & push yaml lên repo (cần cấu hình git credential phù hợp)
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: 'bash'
    env:
      - 'GIT_COMMITTER_NAME=cloudbuild'
      - 'GIT_COMMITTER_EMAIL=cloudbuild@example.com'
      # Nếu dùng token, thêm vào biến môi trường như sau:
      # - 'GIT_TOKEN=ghp_xxx'
    args:
      - '-c'
      - |
        git config --global user.email "cloudbuild@example.com"
        git config --global user.name "cloudbuild"
        # Đảm bảo đang trên branch main hoặc tạo branch main nếu chưa có
        git checkout main || git checkout -b main
        git add backend-deployment.yaml frontend-deployment.yaml
        git commit -m "Update image to ${BUILD_ID} [CI]" || echo "No changes to commit"
        # Nếu dùng HTTPS + token:
        # git push https://<token>@github.com/<user>/<repo>.git HEAD:main
        # Nếu dùng SSH key (đã cấu hình trước):
        git push origin main
    id: 'git-commit'
    waitFor: ['update-yaml']

images:
  - 'gcr.io/empyrean-harbor-456906-s2/backend:latest'
  - 'gcr.io/empyrean-harbor-456906-s2/frontend:latest'

timeout: 1800s
options:
  logging: CLOUD_LOGGING_ONLY
