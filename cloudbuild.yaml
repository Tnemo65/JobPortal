steps:
  # Install backend dependencies
  - name: 'node:18'
    dir: 'backend'
    entrypoint: 'npm'
    args: ['install']
    id: 'backend-install'
    
  # Build backend docker image
  - name: 'gcr.io/cloud-builders/docker'
    dir: 'backend'
    args: ['build', '-t', 'gcr.io/empyrean-harbor-456906-s2/backend:latest', '.']
    id: 'backend-build'
    waitFor: ['backend-install']

  # Push backend to Container Registry
  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', 'gcr.io/empyrean-harbor-456906-s2/backend:latest']
    id: 'backend-push'
    waitFor: ['backend-build']

  # Install frontend dependencies
  - name: 'node:18'
    dir: 'frontend'
    entrypoint: 'npm'
    args: ['install']
    id: 'frontend-install'
    
  # Fix permissions for vite
  - name: 'node:18'
    dir: 'frontend'
    entrypoint: 'chmod'
    args: ['-R', '755', './node_modules/.bin/']
    id: 'fix-permissions'
    waitFor: ['frontend-install']
    
  # Build frontend docker image with production build
  - name: 'gcr.io/cloud-builders/docker'
    dir: 'frontend'
    args: ['build', '-t', 'gcr.io/empyrean-harbor-456906-s2/frontend:latest', '.']
    id: 'frontend-docker-build'
    waitFor: ['fix-permissions']

  # Push frontend to Container Registry
  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', 'gcr.io/empyrean-harbor-456906-s2/frontend:latest']
    id: 'frontend-push'
    waitFor: ['frontend-docker-build']

  # Deploy to Cloud Run (backend)
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: gcloud
    args:
    - 'run'
    - 'deploy'
    - 'backend-service'
    - '--image=gcr.io/empyrean-harbor-456906-s2/backend:latest'
    - '--region=us-central1'
    - '--platform=managed'
    - '--port=8080'
    - '--allow-unauthenticated'
    - '--memory=512Mi'
    - '--cpu=1'
    - '--min-instances=1'
    - '--max-instances=5'
    - '--timeout=300s'
    - '--set-env-vars=MONGO_URI=mongodb+srv://tnemo65ldt:W3Lr6wXF4rDVwAvy@cluster0.q2urbst.mongodb.net/JobPortal,USE_SHARDING=true,SECRET_KEY=your_secret_key,CLOUD_NAME=dcxmce3ff,API_KEY=555454186693259,API_SECRET=tf1uiBCcf4qdBeVKXOuxUqdF3I4,BASE_URL=http://localhost:8080,FRONTEND_URL=http://localhost:5173,GOOGLE_CLIENT_ID=1051764248688-kiv3ptllb1hcl61fpoouks8qro3ta8sl.apps.googleusercontent.com,GOOGLE_CLIENT_SECRET=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,SECRET_ENCRYPTION_KEY=1a8d389921aa670b21d5a3db50d0c779a4e86562329f131df5c55cc6eac7260d,USE_REDIS_CACHE=true,USE_REDIS_SESSIONS=true,REDIS_URL=redis://35.187.154.43:6379'
    waitFor: ['backend-push']
    
    
  # Deploy to Cloud Run (frontend)
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: gcloud
    args:
    - 'run'
    - 'deploy'
    - 'frontend-service'
    - '--image=gcr.io/empyrean-harbor-456906-s2/frontend:latest'
    - '--region=us-central1'
    - '--platform=managed'
    - '--port=3000'
    - '--allow-unauthenticated'
    waitFor: ['frontend-push']

images:
  - 'gcr.io/empyrean-harbor-456906-s2/backend:latest'
  - 'gcr.io/empyrean-harbor-456906-s2/frontend:latest'

timeout: 1800s
options:
  logging: CLOUD_LOGGING_ONLY